블록의 형태가 변형되거나(레드스톤 램프가 켜짐, 피스톤이 밀림), 데이터 값이 변경될 때(노트 블록의 음을 올림, 모닥불로 무언가를 구움) 서버에서 클라이언트로 보내는 일종의 알림입니다.  
마인크래프트에서는 항상 모든 블록을 매 틱마다 처리할 수 없기 때문에, 이와 같은 시스템이 필요합니다.

블록 업데이트의 종류에 따라 우선 순위가 달라집니다.
- 종류
   - PP: `post placement`
   - NC: `neighbor changed`
   - `comparator`

| 정도 | 설명 | 메서드 |
|------|------|--------|
| -3 | 변경 전 업데이트 | 없음 |
| -2 | 변경 후 일부 업데이트 | `Blockstate.onRemove()` |
| -1 | 변경 후 일부 업데이트 | `Blockstate.onPlace()` |
| 0 | 일반 NC 업데이트 | `Level.blockUpdated()` |
| 1 | 일반 comparator 업데이트 | `Level.updateNeighbourForOutputSignal()` |
| 2 | 일반 PP 업데이트 | `Level.updateNeighbourShapes()` |
| 3 | 이후 업데이트 | 없음 |

<br/>

# PP(post placement)
`PP`는 가장 일반적인 블록 업데이트 유형으로 주로 형태가 변경되는 블록(횃불, 선인장, 밀 등) 및 연결 모양이 변경되는 블록(계단, 울타리 등)을 변경하는 데 주로 사용됩니다.

- 블록이 설치 및 파괴, 교체되거나 상태가 변경되면 근처 블록에 `PP` 업데이트를 전송합니다.
- 전송 위치: `east`, `west`, `south`, `north`, `up`, `down`

<img src="assets/img/docs/block_update/pp.png" width="375px"/>

## 예외
- 네더 포탈 생성 및 활성화는 `PP` 업데이트를 전송하지 않습니다.
- 디버그 막대기로 블록의 상태를 변경해도 `PP` 업데이트를 전송하지 않습니다.
- 셜커 상자는 열기 및 닫기를 시작하거나 완료할 때, `PP` 업데이트를 전송합니다.
- 레드스톤 가루가 설치, 파괴, 교체되거나, 상태가 변경될 때, 가루가 가리키고 있는 블록이 레드스톤 가루가 아니면, 그 위 블록에도 `PP` 업데이트를 전송합니다.

<div style="display:flex; gap:20px;">
   <div style="text-align:center;">
      <img src="assets/img/docs/block_update/qc1.png" width="256px"/>
      <div style="font-size:12px; color:#bbb;">레드스톤 가루 변경하기 전</div>
   </div>
   <span style="font-size: 24px; margin-top: 128px">></span>
   <div style="text-align:center;">
      <img src="assets/img/docs/block_update/qc2.png" width="256px"/>
      <div style="font-size:12px; color:#bbb;">레드스톤 가루 변경한 후</div>
   </div>
</div>

## 블록
| 블록 | `PP` 수신 후 |
|------|--------------|
| 부착 가능한 블록(`횃불`, `눈`, `양탄자`, `문`, `불` 등) | 아이템 형태로 떨어뜨리려 합니다. |
| 연결 가능한 블록(`울타리`, `계단`, `상자`, `레드스톤 가루`, `네더 포탈` 등) | 모양을 변경하려 시도합니다. |
| 레드스톤 중계기 | 잠겨 있는 상태인지 또는 잠금이 해제되어 있는 상태인지 확인합니다. |
| 노트 블록 | 악기 유형을 업데이트하려 시도합니다. |
| 나뭇잎 | 원목과의 거리를 계산합니다. |
| 콘크리트 가루 | 물과 접촉하면 굳으려합니다. |
| 물 또는 물에 잠기는 블록 | 물은 이동해야 할 곳을 알아내기 위해 틱을 예약합니다. |
| 관측기 | 펄스를 일으키기 위해 틱을 예약합니다. |
| 중력의 영향을 받는 블록(`모래`, `자갈` 등) | 낙하 여부를 확인하기 위해 틱을 예약합니다. |
| 흙 길과 경작지 | 고체 블록으로 덮여 있는지 확인하기 위해 틱을 예약합니다. |
| 선인장 | 선인장이 죽는지(블록이 없어지는지) 확인하기 위해 틱을 예약합니다. |
| 산호 | 물 밖에 있는지 확인하기 위해 틱을 예약합니다. |
| 마그마 블록 | 거품 기둥을 생성하기 위해 틱을 예약합니다. |

<br/>

# NC(neighbor changed)
`NC`는 주로 레드스톤 구성 요소에 사용되는 블록 업데이트 유형입니다.

- 블록이 설치 및 파괴, 교체되거나 상태가 변경되면 근처 블록에 `NC` 업데이트를 전송합니다.
- 전송 위치: `east`, `west`, `south`, `north`, `up`, `down`

<img src="assets/img/docs/block_update/pp.png" width="375px"/>

## 예외
<details class="details">
<summary><span/>일부는 <code>NC</code> 업데이트를 생성하지 않습니다</summary>

   - `대나무`: 위쪽 부분이 두꺼워질 때
   - `죽순`: 대나무로 자라날 때
   - `물`과 `거품 기둥`: 서로를 변환할 때
   - `조각된 호박`, `잭 오 랜턴`, `눈 블록`, `철 블록`: 골렘으로 변할 때
   - `식물`: `2` 블록으로 자라날 때(잔디 → 키 큰 잔디)
   - `가마솥`: 수위가 변할 때
   - `후렴꽃`과 `후렴초`: 자라나거나, 열매가 익거나, 모양이 변할 때
   - `코코아 콩`: 자라날 때
   - `레드스톤 중계기`: 켜지거나 꺼질 때
   - `산호`, `부채형 산호`, `산호 블록`: 죽을 때
   - `밀`, `감자`, `당근`, `비트`: 자라날 때
   - `문`, `다락문`, `울타리 문`: 열기, 닫기, 활성화, 혹은 비활성화할 때
   - `드래곤 알`: 목적지에 운송될 때
   - `경작지`: 젖거나, 마를 때
   - `살얼음`: 서서히 녹을 때(그러나, 물로 바뀌지는 않을 때)
   - `주크박스`: 음반을 넣거나, 꺼낼 때
   - `네더 사마귀`: 자라날 때
   - `관측기`: 켜지거나, 꺼질 때
   - `레드스톤 조명`: 켜지거나, 꺼질 때
   - `불우렁쉥이`: 뼛가루를 사용하여 개수가 늘어날 때
   - `스펀지`: 물을 흡수할 때
   - `수박 줄기`와 `호박 줄기`: 자라날 때, 수박이나 호박이 제거될 때
   - `달콤한 열매`: 자라날 때, 열매를 수확할 때
   - `거북이 알`: 알 개수가 감소할 때
   - `덩굴`: 자라나서 모양이 바뀔 때, 새 덩굴이 생성될 때
   - `위더` 스켈레톤 해골, 영혼의 흙, 영혼 모래: 위더를 소환할 때
   - `잔디 블록`: 양에게 먹힐 때
   - `당근`: 토끼에게 먹힐 때
   - `모루`: 손상될 때
   - `엔드 차원문 틀`: 엔더의 눈이 설치될 때
   - `엔드 포탈`: 생성될 때
   - `양조기`: 병이나 물약이 추가될 때
   - `구조물 블록`, `명령 블록`: 모드를 변경할 때
   - `선인장`과 `사탕수수`: 자라날 때
   - `햇빛 감지기`: 모드를 변경할 때
   - `발사기`, `공급기`, `호퍼`: 활성화 되거나, 모양이 변경될 때
   - `불`: 시간이 지나거나 모양이 변할 때
   - `묘목`: stage 값이 변할 때
   - `실`: disarmed 값이 변경될 때
   - `침대`: 누군가 누워 있거나, 비어 있을 때
   - `네더 포탈`과 `흑요석`: 네더 포탈이 생성될 때
   - `모닥불`: 아래에 건초 더미를 설치하거나 파괴할 때
   - `울타리`, `계단`, `유리판`, `철창`, `버섯블록`, `담장`: 모양이 변할 때
   - `잔디 블록`, `회백토`, `균사체`: 눈으로 덮이거나 덮이지 않을 때
   - `켈프`, `늘어진 덩굴`, `뒤틀린 덩굴`: 자라날 때, 위/아래에 해당 블록을 설치하거나 파괴할 때
   - `압력판`: 신호가 변경될 때
   - `모든 블록`: 디버그 막대기를 이용해 상태를 변경할 때, 명령어에 의해 재설치될 때
</details>

## 기타
레드스톤 관련 블록은 다른 블록의 `NC` 업데이트와 달리 더 넓고 많은 `NC` 업데이트를 전송합니다.

<div style="display:flex; gap:20px;">
  <div style="text-align:center;">
      <img src="assets/img/docs/block_update/lever.png" width="256px"/>
      <div style="font-size:12px; color:#bbb;">레버</div>
  </div>
  <div style="text-align:center;">
      <img src="assets/img/docs/block_update/repeator.png" width="256px"/>
      <div style="font-size:12px; color:#bbb;">중계기</div>
  </div>
  <div style="text-align:center;">
      <img src="assets/img/docs/block_update/chest.png" width="256px"/>
      <div style="font-size:12px; color:#bbb;">상자</div>
  </div>
  <div style="text-align:center;">
      <img src="assets/img/docs/block_update/trapped_chest.png" width="256px"/>
      <div style="font-size:12px; color:#bbb;">덫 상자</div>
  </div>
  <div style="text-align:center;">
      <img src="assets/img/docs/block_update/observer.png" width="256px"/>
      <div style="font-size:12px; color:#bbb;">관측기</div>
  </div>
  <div style="text-align:center;">
      <img src="assets/img/docs/block_update/redstone_torch.png" width="256px"/>
      <div style="font-size:12px; color:#bbb;">레드스톤 횃불</div>
  </div>
</div>

## 블록
다음 블록만 `NC` 업데이트를 수신하여, 상태가 변할 수 있습니다.

| 블록 | `NC` 수신 후 |
|------|--------------|
| 살얼음 | 녹으려고합니다. |
| 레드스톤 가루 | 상태를 변경하려고 합니다. |
| 레드스톤 중계기 | 상태를 변경하려고 합니다. |
| 레드스톤 비교기 | 상태를 변경하려고 합니다. |
| 레드스톤 횃불 | 상태를 변경하려고 합니다. |
| 레일 | 상태를 변경하려고 합니다. |
| 감지 레일 | 상태를 변경하려고 합니다. |
| 활성화 레일 | 상태를 변경하려고 합니다. |
| 동력 레일 | 상태를 변경하려고 합니다. |
| 명령 블록 | 상태를 변경하려고 합니다. |
| 공급기 | 상태를 변경하려고 합니다. |
| 발사기 | 상태를 변경하려고 합니다. |
| 노트 블록 | 상태를 변경하려고 합니다. |
| 레드스톤 조명 | 상태를 변경하려고 합니다. |
| TNT | 상태를 변경하려고 합니다. |
| 피스톤 | 상태를 변경하려고 합니다. |
| 다락문 | 상태를 변경하려고 합니다. |
| 울타리 문 | 상태를 변경하려고 합니다. |
| 문 | 상태를 변경하려고 합니다. |
| 물 | 올바른 형태로 만들려고 시도합니다. |
| 용암 | 올바른 형태로 만들려고 시도합니다. |
| 영혼 모래 | 거품 기둥을 생성하기 위해 틱을 예약합니다. |
| 스펀지 | 물을 흡수하려고 합니다. |

<br/>

# 명령 블록
`BlockEntity`인 명령 블록은 명령어 성공 결과 및 실패 피드백 변경 사항을 클라이언트로 전송하게 됩니다.
- `NC`, `PP` 업데이트를 전송하지 않습니다.

<span style="color: #FF9955">일반 명령 블록</span>의 경우, 실행 시에만 `Block Update` 패킷을 전송합니다.  
<span style="color: #9955FF">반복형 명령 블록</span>의 경우, 매 틱 실행할 때마다 `Block Update` 패킷을 전송합니다.

- 실제 인게임 패킷(`Server` -> `Client`)
```json
{
   "blockstate": 13538,
   "pos": {
      "x": 0,
      "y": 0,
      "z": 0
   }
}
```

- 이때, 클라이언트에 패킷이 전송되는 범위는 렌더 거리에만 영향을 받습니다.
   - `시뮬레이션 거리`는 해당 패킷의 전송에 아무런 영향을 끼치지 않습니다.
   - `y` 좌표는 이 거리에 영향을 받지 않습니다. (`y`가 `Block Update` 패킷 범위를 넘겼다 하더라도 패킷이 전송됩니다)

범위는 다음 식으로 구현됩니다.
- <img class="latex" src="https://latex.codecogs.com/svg.image?$Block \_ Update = 16 *(d + 2)$" style="vertical-align:middle; filter: invert(1)"/>

   - 예를 들어, 렌더 거리가 `2`일 경우, `Block Update` 패킷 전송 최대 범위는 `63.99...`(`x`, `z`)까지 입니다. (`64.0` 이상 이동 시, 패킷 전송이 정지됨)
   - 근처 플레이어의 좌표가 `0 64 0`이더라도 패킷을 전송합니다. (`y`는 제외됨)

이 패킷 전송을 그만두게 만들고 싶으면 명령 블록의 출력 설정을 끄면 됩니다.
<div style="text-align:left;">
   <img src="assets/img/docs/block_update/output_x.png" width="750px"/>
   <div style="font-size:14px; color:#bbb;"><code>레드스톤 필요</code> 설정 탭 위쪽에 <code>X</code>가 보이도록 명령 블록을 설정하면 됩니다.</div>
</div>

실제로는 패킷으로 인한 비용 감소보다 `LastOutput` 출력에 쓰이는 `text_components` 파서가 작동하지 않는 비용 감소가 훨씬 큽니다.